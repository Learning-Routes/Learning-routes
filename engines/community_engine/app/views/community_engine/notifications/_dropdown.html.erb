<div style="position:relative;"
     data-controller="notifications"
     data-notifications-url-value="<%= community_engine.unread_count_notifications_path %>">

  <%= turbo_stream_from "notifications_#{current_user.id}" %>

  <%# Bell trigger %>
  <button data-action="click->notifications#toggle"
          style="position:relative; padding:0.4rem; border-radius:11px; border:none; background:transparent;
                 color:var(--color-muted, #6B6560); cursor:pointer; transition:all 0.15s;">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
    </svg>
    <span id="notification_badge"
          data-notifications-target="badge"
          style="display:none; position:absolute; top:-2px; right:-2px; min-width:16px; height:16px; padding:0 4px;
                 border-radius:8px; background:#ef4444; color:white; font-family:'DM Mono',monospace;
                 font-size:0.55rem; font-weight:700; line-height:16px; text-align:center;">
      0
    </span>
  </button>

  <%# Dropdown panel â€” uses theme variables for day/night compatibility %>
  <div data-notifications-target="dropdown"
       style="display:none; position:absolute; right:0; top:100%; margin-top:0.5rem; width:22rem; max-width:calc(100vw - 2rem);
              background:var(--color-card, #FEFDFB); border-radius:14px; border:1px solid var(--color-faint, rgba(28,24,18,0.08));
              box-shadow:0 16px 48px rgba(0,0,0,0.15); z-index:50; overflow:hidden;">

    <%# Header %>
    <div style="display:flex; align-items:center; justify-content:space-between; padding:0.75rem 1rem; border-bottom:1px solid var(--color-faint, rgba(28,24,18,0.06));">
      <h3 style="font-family:'DM Sans',sans-serif; font-weight:700; font-size:0.82rem; color:var(--color-txt, #1C1812); margin:0;">
        <%= t("community_engine.notifications_ui.title") %>
      </h3>
      <button data-action="click->notifications#markAllRead"
              style="font-family:'DM Sans',sans-serif; font-size:0.68rem; color:var(--color-muted, #9B9590); background:none; border:none; cursor:pointer; transition:color 0.15s;">
        <%= t("community_engine.notifications_ui.mark_all_read") %>
      </button>
    </div>

    <%# Notification list %>
    <div data-notifications-target="list" style="max-height:20rem; overflow-y:auto;">
      <% notifications = current_user.notifications.recent.includes(:actor, :notifiable).limit(15) %>
      <% if notifications.any? %>
        <% notifications.each do |notification| %>
          <% next unless notification.actor %>
          <div class="notification-item"
               style="display:flex; align-items:flex-start; gap:0.6rem; padding:0.75rem 1rem;
                      border-bottom:1px solid var(--color-faint, rgba(28,24,18,0.06)); cursor:pointer; transition:background 0.15s;
                      <%= notification.unread? ? 'background:rgba(96,165,250,0.06);' : 'opacity:0.6;' %>"
               data-action="click->notifications#markRead"
               data-notification-id="<%= notification.id %>">
            <%# Actor avatar %>
            <div style="flex-shrink:0; width:30px; height:30px; border-radius:50%; background:var(--color-accent, #2C261E);
                        display:flex; align-items:center; justify-content:center; color:var(--color-accent-text, #F5F1EB);
                        font-family:'DM Sans',sans-serif; font-size:0.6rem; font-weight:700;">
              <%= notification.actor.name.to_s.first&.upcase || "?" %>
            </div>
            <div style="flex:1; min-width:0;">
              <p style="font-family:'DM Sans',sans-serif; font-size:0.78rem; color:var(--color-txt, #1C1812); line-height:1.4; margin:0;">
                <span style="font-weight:600;"><%= notification.actor.name %></span>
                <span style="color:var(--color-muted, #9B9590);"> <%= notification.notification_text %></span>
              </p>
              <span style="font-family:'DM Mono',monospace; font-size:0.55rem; color:var(--color-muted, #9B9590); margin-top:0.2rem; display:block;">
                <%= time_ago_in_words(notification.created_at) %>
              </span>
            </div>
            <% if notification.unread? %>
              <span style="flex-shrink:0; width:6px; height:6px; border-radius:50%; background:#60A5FA; margin-top:0.4rem;"></span>
            <% end %>
          </div>
        <% end %>
      <% else %>
        <div style="padding:2rem 1rem; text-align:center;">
          <p style="font-family:'DM Sans',sans-serif; font-size:0.78rem; color:var(--color-muted, #9B9590); margin:0;">
            <%= t("community_engine.notifications_ui.empty") %>
          </p>
        </div>
      <% end %>
    </div>

    <%# Footer %>
    <div style="padding:0.5rem 1rem; border-top:1px solid var(--color-faint, rgba(28,24,18,0.06));">
      <%= link_to community_engine.notifications_path,
            style: "display:block; text-align:center; font-family:'DM Sans',sans-serif; font-size:0.72rem; color:var(--color-muted, #9B9590); text-decoration:none; transition:color 0.15s;" do %>
        <%= t("community_engine.notifications_ui.view_all") %>
      <% end %>
    </div>
  </div>
</div>
