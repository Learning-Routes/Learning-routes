<div id="comment_<%= comment.id %>"
     style="display:flex; gap:0.75rem; padding:1rem 0; <%= comment.parent_id? ? 'margin-left:2.5rem; border-left:2px solid var(--color-faint, #E8E4DC); padding-left:1rem;' : '' %>">
  <%# Avatar %>
  <div style="flex-shrink:0; width:32px; height:32px; border-radius:50%; background:var(--color-accent, #2C261E);
              display:flex; align-items:center; justify-content:center; color:var(--color-accent-text, #F5F1EB);
              font-family:'DM Sans',sans-serif; font-size:0.65rem; font-weight:700;">
    <%= comment.user.name.to_s.first&.upcase || "?" %>
  </div>

  <div style="flex:1; min-width:0;">
    <%# Header: name + time + edited badge %>
    <div style="display:flex; align-items:center; gap:0.5rem; margin-bottom:0.3rem;">
      <span style="font-family:'DM Sans',sans-serif; font-size:0.82rem; font-weight:600; color:var(--color-txt, #1C1812);">
        <%= comment.user.name %>
      </span>
      <span style="font-family:'DM Mono',monospace; font-size:0.65rem; color:var(--color-muted, #9B9590);">
        <%= time_ago_in_words(comment.created_at) %>
      </span>
      <% if comment.edited? %>
        <span style="font-family:'DM Mono',monospace; font-size:0.55rem; color:var(--color-muted, #9B9590); background:var(--color-faint, rgba(28,24,18,0.06)); padding:0.15rem 0.4rem; border-radius:6px;">
          <%= t("community_engine.comments.edited") %>
        </span>
      <% end %>
    </div>

    <%# Body %>
    <p data-comment-body style="font-family:'DM Sans',sans-serif; font-size:0.82rem; color:var(--color-sub, #3D3730); line-height:1.6; margin:0 0 0.5rem;">
      <%= simple_format(comment.body, {}, wrapper_tag: "span") %>
    </p>

    <%# Actions %>
    <div style="display:flex; align-items:center; gap:0.75rem;">
      <%= render "community_engine/likes/button", likeable: comment, liked: (defined?(current_user) && current_user ? comment.liked_by?(current_user) : false), likes_count: comment.likes_count %>

      <% if comment.top_level? %>
        <button style="font-family:'DM Sans',sans-serif; font-size:0.72rem; color:var(--color-muted, #6B6560); background:none; border:none; cursor:pointer; padding:0.2rem 0; transition:color 0.2s;"
                data-action="click->comment-reply#show"
                data-comment-id="<%= comment.id %>">
          <%= t("community_engine.comments.reply") %>
        </button>
      <% end %>

      <% if defined?(current_user) && current_user && comment.owned_by?(current_user) %>
        <button style="font-family:'DM Sans',sans-serif; font-size:0.72rem; color:var(--color-muted, #6B6560); background:none; border:none; cursor:pointer; padding:0.2rem 0; transition:color 0.2s;"
                data-action="click->comment-edit#show"
                data-comment-id="<%= comment.id %>">
          <%= t("community_engine.comments.edit") %>
        </button>
        <%= button_to community_engine.comment_path(comment), method: :delete,
              style: "font-family:'DM Sans',sans-serif; font-size:0.72rem; color:var(--color-muted, #6B6560); background:none; border:none; cursor:pointer; padding:0.2rem 0; transition:color 0.2s;",
              data: { turbo_confirm: t("community_engine.comments.delete_confirm") } do %>
          <%= t("community_engine.comments.delete") %>
        <% end %>
      <% end %>
    </div>

    <%# Reply form placeholder %>
    <div id="reply_form_<%= comment.id %>" style="display:none; margin-top:0.75rem;">
      <%= render "community_engine/comments/form", commentable: comment.commentable, parent_id: comment.id %>
    </div>

    <%# Nested replies (max 2 levels) %>
    <% if comment.top_level? && comment.replies.any? %>
      <div style="margin-top:0.75rem;">
        <% comment.replies.order(created_at: :asc).each do |reply| %>
          <%= render "community_engine/comments/comment", comment: reply %>
        <% end %>
      </div>
    <% end %>
  </div>
</div>
