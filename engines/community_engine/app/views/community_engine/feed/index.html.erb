<% content_for(:title, t("community_engine.feed.title")) %>
<% content_for(:full_width, true) %>

<style>
  .community-sidebar { display: none; }
  @media (min-width: 1024px) { .community-sidebar { display: block !important; } }
</style>

<div style="margin:0 auto; padding:2.5rem clamp(2rem, 5vw, 4rem); max-width:1800px;">
  <%# Page header %>
  <div style="margin-bottom:2.5rem;">
    <h1 style="font-family:'DM Sans',sans-serif; font-weight:700; font-size:2rem; letter-spacing:-0.5px; color:var(--color-txt, #1C1812); margin:0 0 0.5rem;">
      <%= t("community_engine.feed.title") %>
    </h1>
    <div style="display:flex; align-items:center; gap:0.75rem; font-family:'DM Mono',monospace; font-size:0.82rem; color:var(--color-muted, #887F72);">
      <span><%= @stats[:total_users] %> <%= t("community_engine.feed.stats.learners") %></span>
      <span style="width:3px; height:3px; border-radius:50%; background:var(--color-faint, #CCC5B8);"></span>
      <span><%= @stats[:total_routes] %> <%= t("community_engine.feed.stats.routes") %></span>
      <span style="width:3px; height:3px; border-radius:50%; background:var(--color-faint, #CCC5B8);"></span>
      <span><%= @stats[:total_shared] %> <%= t("community_engine.feed.stats.shared") %></span>
    </div>
  </div>

  <div style="display:flex; gap:3rem;">
    <%# Main content area %>
    <div style="flex:1; min-width:0;">
      <%# Tab bar %>
      <div style="display:flex; align-items:center; gap:0.35rem; margin-bottom:2rem; padding:0.35rem;
                  background:var(--color-faint, rgba(28,24,18,0.04)); border-radius:14px; width:fit-content;">
        <% [
          ["all", t("community_engine.feed.tabs.all")],
          ["following", t("community_engine.feed.tabs.following")],
          ["trending", t("community_engine.feed.tabs.trending")]
        ].each do |tab_id, tab_label| %>
          <% active = @tab == tab_id %>
          <%= link_to community_engine.feed_path(tab: (tab_id == "all" ? nil : tab_id)),
                style: "display:inline-block; padding:0.65rem 1.8rem; border-radius:11px; font-family:'DM Sans',sans-serif; font-size:0.95rem; font-weight:500; text-decoration:none; transition:all 0.15s; #{active ? "background:var(--color-accent, #2C261E); color:var(--color-accent-text, #F5F1EB); box-shadow:0 1px 3px rgba(0,0,0,0.1);" : "color:var(--color-muted, #887F72);"}",
                data: { turbo_action: "replace" } do %>
            <%= tab_label %>
          <% end %>
        <% end %>
      </div>

      <%# Feed content %>
      <% if @tab == "trending" %>
        <%= render "community_engine/feed/trending_list", trending_routes: @trending_routes || [] %>
      <% else %>
        <%# === COMMENTS / POSTS SECTION (at the very top) === %>
        <div style="margin-bottom:2.5rem;">
          <h2 style="font-family:'DM Sans',sans-serif; font-weight:700; font-size:1.45rem; color:var(--color-txt, #1C1812); margin:0 0 1.25rem;">
            <%= t("community_engine.feed.posts_heading") %>
          </h2>

          <%# Post form (logged-in users) %>
          <% if defined?(current_user) && current_user %>
            <%= render "community_engine/posts/post_form" %>
          <% end %>

          <div id="posts_list" style="display:flex; flex-direction:column; gap:1.25rem;">
            <% if @posts.present? && @posts.any? %>
              <% @posts.each do |post| %>
                <%= render "community_engine/posts/post", post: post %>
              <% end %>
            <% else %>
              <p style="font-family:'DM Sans',sans-serif; font-size:1rem; color:var(--color-muted, #887F72); text-align:center;
                        padding:3rem; background:var(--color-card, rgba(255,255,255,0.6)); backdrop-filter:blur(20px); -webkit-backdrop-filter:blur(20px);
                        border:1px solid var(--color-faint, rgba(28,24,18,0.06)); border-radius:16px;">
                <%= t("community_engine.feed.posts_empty") %>
              </p>
            <% end %>
          </div>
        </div>

        <%# Floating thoughts â€” best comments highlighting (between posts and routes) %>
        <%= render "community_engine/feed/floating_thoughts", thoughts: @floating_thoughts || [] %>

        <%# === SHARED ROUTE ACTIVITIES (below comments) === %>
        <h2 style="font-family:'DM Sans',sans-serif; font-weight:700; font-size:1.45rem; color:var(--color-txt, #1C1812); margin:0 0 1.25rem;">
          <%= t("community_engine.feed.tabs.all") %>
        </h2>
        <%= render "community_engine/feed/activity_list", activities: @activities %>
      <% end %>
    </div>

    <%# Sidebar (desktop only) %>
    <div class="community-sidebar" style="width:380px; flex-shrink:0;">
      <%= render "community_engine/feed/sidebar" %>
    </div>
  </div>
</div>
