<% content_for(:title, t("community_engine.feed.title")) %>
<% content_for(:full_width, true) %>

<style>
  .community-sidebar { display: none; }
  @media (min-width: 1024px) { .community-sidebar { display: block !important; } }
  .feed-card:hover { box-shadow: 0 2px 12px rgba(0,0,0,0.06); }
</style>

<div style="margin:0 auto; padding:1.75rem clamp(1.5rem, 4vw, 3rem); max-width:1280px;">
  <%# Page header — compact %>
  <div style="display:flex; align-items:baseline; gap:1rem; margin-bottom:1.5rem; flex-wrap:wrap;">
    <h1 style="font-family:'DM Sans',sans-serif; font-weight:700; font-size:1.5rem; letter-spacing:-0.4px; color:var(--color-txt, #1C1812); margin:0;">
      <%= t("community_engine.feed.title") %>
    </h1>
    <div style="display:flex; align-items:center; gap:0.6rem; font-family:'DM Mono',monospace; font-size:0.72rem; color:var(--color-muted, #887F72);">
      <span><%= @stats[:total_users] %> <%= t("community_engine.feed.stats.learners") %></span>
      <span style="width:3px; height:3px; border-radius:50%; background:var(--color-faint, #CCC5B8);"></span>
      <span><%= @stats[:total_routes] %> <%= t("community_engine.feed.stats.routes") %></span>
      <span style="width:3px; height:3px; border-radius:50%; background:var(--color-faint, #CCC5B8);"></span>
      <span><%= @stats[:total_shared] %> <%= t("community_engine.feed.stats.shared") %></span>
    </div>
  </div>

  <div style="display:flex; gap:2rem; align-items:flex-start;">
    <%# Main content area %>
    <div style="flex:1; min-width:0;">
      <%# Tab bar — compact pill style %>
      <div style="display:flex; align-items:center; gap:0.25rem; margin-bottom:1.25rem; padding:0.25rem;
                  background:var(--color-faint, rgba(28,24,18,0.04)); border-radius:10px; width:fit-content;">
        <% [
          ["all", t("community_engine.feed.tabs.all")],
          ["following", t("community_engine.feed.tabs.following")],
          ["trending", t("community_engine.feed.tabs.trending")]
        ].each do |tab_id, tab_label| %>
          <% active = @tab == tab_id %>
          <%= link_to community_engine.feed_path(tab: (tab_id == "all" ? nil : tab_id)),
                style: "display:inline-block; padding:0.45rem 1.25rem; border-radius:8px; font-family:'DM Sans',sans-serif; font-size:0.82rem; font-weight:500; text-decoration:none; transition:all 0.15s; #{active ? "background:var(--color-accent, #2C261E); color:var(--color-accent-text, #F5F1EB); box-shadow:0 1px 3px rgba(0,0,0,0.1);" : "color:var(--color-muted, #887F72);"}",
                data: { turbo_action: "replace" } do %>
            <%= tab_label %>
          <% end %>
        <% end %>
      </div>

      <%# Feed content %>
      <% if @tab == "trending" %>
        <%= render "community_engine/feed/trending_list", trending_routes: @trending_routes || [] %>
      <% else %>
        <%# Post form (logged-in users) %>
        <% if defined?(current_user) && current_user %>
          <%= render "community_engine/posts/post_form" %>
        <% end %>

        <%# Posts + Activity — unified feed (no section headers, just a clean stream) %>
        <div style="display:flex; flex-direction:column; gap:0.75rem;">
          <% if @posts.present? && @posts.any? %>
            <% @posts.each do |post| %>
              <%= render "community_engine/posts/post", post: post %>
            <% end %>
          <% end %>

          <%# Floating thoughts — compact inline banner (only if present) %>
          <% if @floating_thoughts.present? && @floating_thoughts.any? %>
            <%= render "community_engine/feed/floating_thoughts", thoughts: @floating_thoughts %>
          <% end %>

          <%# Activity stream %>
          <% if @activities.present? && @activities.any? %>
            <% @activities.each do |activity| %>
              <%= render "community_engine/feed/activity_card", activity: activity %>
            <% end %>
          <% else %>
            <% unless @posts.present? && @posts.any? %>
              <div style="background:var(--color-card, rgba(255,255,255,0.6)); border:1px solid var(--color-faint, rgba(28,24,18,0.06));
                          border-radius:12px; padding:2.5rem 1.5rem; text-align:center;">
                <p style="font-family:'DM Sans',sans-serif; font-size:0.85rem; font-weight:600; color:var(--color-txt, #1C1812); margin:0 0 0.25rem;">
                  <%= t("community_engine.feed.empty.title") %>
                </p>
                <p style="font-family:'DM Sans',sans-serif; font-size:0.78rem; color:var(--color-muted, #887F72); margin:0; line-height:1.5;">
                  <%= t("community_engine.feed.empty.subtitle") %>
                </p>
              </div>
            <% end %>
          <% end %>
        </div>
      <% end %>
    </div>

    <%# Sidebar (desktop only) %>
    <div class="community-sidebar" style="width:320px; flex-shrink:0; position:sticky; top:72px;">
      <%= render "community_engine/feed/sidebar" %>
    </div>
  </div>
</div>
