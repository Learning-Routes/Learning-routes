<% if activity.user %>
<%
  shared_route = case activity.trackable
                 when CommunityEngine::SharedRoute then activity.trackable
                 else nil
                 end
  route_link = shared_route ? community_engine.shared_route_path(shared_route.share_token) : nil
%>

<div class="feed-card" style="background:var(--color-card, rgba(255,255,255,0.6)); backdrop-filter:blur(16px); -webkit-backdrop-filter:blur(16px);
            border:1px solid var(--color-faint, rgba(28,24,18,0.06)); border-radius:12px; padding:0.85rem 1.25rem; transition:box-shadow 0.15s;">
  <div style="display:flex; align-items:flex-start; gap:0.75rem;">
    <%# Avatar %>
    <div style="width:32px; height:32px; border-radius:50%; background:var(--color-accent, #2C261E);
                display:flex; align-items:center; justify-content:center; color:var(--color-accent-text, #F5F1EB);
                font-family:'DM Sans',sans-serif; font-size:0.65rem; font-weight:700; flex-shrink:0; margin-top:0.1rem;">
      <%= activity.user.name.to_s.first&.upcase || "?" %>
    </div>

    <div style="flex:1; min-width:0;">
      <%# Action line — single compact line %>
      <p style="font-family:'DM Sans',sans-serif; font-size:0.82rem; color:var(--color-sub, #6D665B); margin:0; line-height:1.5;">
        <span style="font-weight:600; color:var(--color-txt, #1C1812);"><%= activity.user.name %></span>
        <span style="color:var(--color-muted, #887F72);"> <%= activity.action_text %></span>
        <% if activity.trackable.present? %>
          <% case activity.trackable %>
          <% when CommunityEngine::SharedRoute %>
            <% if route_link %>
              <%= link_to community_engine.shared_route_path(shared_route.share_token),
                    style: "font-weight:500; color:var(--color-txt, #1C1812); text-decoration:none; border-bottom:1px solid var(--color-faint, rgba(28,24,18,0.15));" do %>
                <%= activity.trackable.learning_route&.localized_topic %>
              <% end %>
            <% else %>
              <span style="font-weight:500; color:var(--color-txt, #1C1812);"><%= activity.trackable.learning_route&.localized_topic %></span>
            <% end %>
          <% when LearningRoutesEngine::LearningRoute %>
            <span style="font-weight:500; color:var(--color-txt, #1C1812);"><%= activity.trackable.localized_topic %></span>
          <% when LearningRoutesEngine::RouteStep %>
            <span style="font-weight:500; color:var(--color-txt, #1C1812);"><%= activity.trackable.localized_title %></span>
          <% when Core::User %>
            <span style="font-weight:500; color:var(--color-txt, #1C1812);"><%= activity.trackable.name %></span>
          <% else %>
            <% if activity.metadata&.dig("preview").present? %>
              <span style="font-weight:500; color:var(--color-txt, #1C1812);"><%= activity.metadata["preview"].truncate(60) %></span>
            <% end %>
          <% end %>
        <% end %>
        <span style="font-family:'DM Mono',monospace; font-size:0.62rem; color:var(--color-muted, #887F72); margin-left:0.35rem;">
          <%= time_ago_in_words(activity.created_at) %>
        </span>
      </p>

      <%# Description preview (shared route with description) %>
      <% if shared_route&.description.present? %>
        <p style="font-family:'DM Sans',sans-serif; font-size:0.78rem; color:var(--color-muted, #887F72); margin:0.3rem 0 0; line-height:1.4;
                  display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden;">
          "<%= shared_route.description.truncate(120) %>"
        </p>
      <% end %>

      <%# Shared route extras — rating + stats on same row %>
      <% if shared_route %>
        <div style="display:flex; align-items:center; gap:0.75rem; margin-top:0.35rem; flex-wrap:wrap;">
          <%= render "community_engine/ratings/stars", shared_route: shared_route, interactive: false %>
          <span style="display:inline-flex; align-items:center; gap:0.2rem; font-family:'DM Mono',monospace; font-size:0.62rem; color:var(--color-muted, #887F72);">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z"/></svg>
            <%= shared_route.likes_count %>
          </span>
          <span style="display:inline-flex; align-items:center; gap:0.2rem; font-family:'DM Mono',monospace; font-size:0.62rem; color:var(--color-muted, #887F72);">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
            <%= shared_route.comments_count %>
          </span>
          <%= link_to community_engine.shared_route_path(shared_route.share_token),
                style: "font-family:'DM Sans',sans-serif; font-size:0.68rem; font-weight:500; color:var(--color-muted, #887F72); text-decoration:none; margin-left:auto;" do %>
            <%= t("community_engine.feed.trending.view_route") %> →
          <% end %>
        </div>

        <%# Inline floating thought — best comment %>
        <%= render "community_engine/feed/inline_thought", shared_route: shared_route %>
      <% end %>
    </div>

    <%# Action icon — smaller, aligned to top %>
    <div style="flex-shrink:0; color:var(--color-muted, #887F72); opacity:0.5; margin-top:0.15rem;">
      <% case activity.action %>
      <% when "commented" %>
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" stroke-linecap="round" stroke-linejoin="round"/></svg>
      <% when "liked" %>
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z" stroke-linecap="round" stroke-linejoin="round"/></svg>
      <% when "followed" %>
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M16 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2M8.5 3a4 4 0 110 8 4 4 0 010-8zM20 8v6m3-3h-6" stroke-linecap="round" stroke-linejoin="round"/></svg>
      <% when "shared" %>
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" stroke-linecap="round" stroke-linejoin="round"/></svg>
      <% when "completed_step", "completed_route" %>
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" stroke-linecap="round" stroke-linejoin="round"/></svg>
      <% when "cloned_route" %>
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" stroke-linecap="round" stroke-linejoin="round"/></svg>
      <% else %>
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="3" stroke-linecap="round" stroke-linejoin="round"/></svg>
      <% end %>
    </div>
  </div>
</div>
<% end %>
