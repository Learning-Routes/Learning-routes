<%# Full Audio Lesson Layout
     locals: step (RouteStep), content (AiContent, optional) %>

<% content ||= ContentEngine::AiContent.where(route_step: step).by_type(:text).first %>
<% narration = content&.metadata&.dig("narration") || {} %>

<div class="mx-auto max-w-3xl px-4 sm:px-6 lg:px-8 py-8">

  <%# ── Header: icon + title + badge + duration ── %>
  <div class="mb-6">
    <div class="flex items-center gap-3 mb-2">
      <%# Audio icon %>
      <div class="w-10 h-10 rounded-[11px] flex items-center justify-center flex-shrink-0"
           style="background: rgba(99,102,241,0.15);">
        <svg class="w-5 h-5" style="color: #818CF8;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"/>
        </svg>
      </div>

      <div class="flex-1 min-w-0">
        <h1 class="text-2xl font-bold truncate" style="color: #E8E4DC; font-family: 'DM Sans', sans-serif;">
          <%= step.localized_title %>
        </h1>
      </div>

      <%# Badge + duration %>
      <div class="flex items-center gap-2 flex-shrink-0">
        <span class="px-2.5 py-1 text-xs font-medium uppercase tracking-wider rounded-full"
              style="background: rgba(99,102,241,0.15); color: #818CF8; font-family: 'DM Mono', monospace;">
          <%= t("audio_lesson.label") %>
        </span>
        <% if step.estimated_minutes.present? %>
          <span class="text-xs" style="color: #7A7264; font-family: 'DM Mono', monospace;">
            <%= step.estimated_minutes %> <%= t("units.min") %>
          </span>
        <% end %>
      </div>
    </div>

    <% if step.localized_description.present? %>
      <p class="text-sm mt-1" style="color: #7A7264; font-family: 'DM Sans', sans-serif;">
        <%= step.localized_description %>
      </p>
    <% end %>
  </div>

  <%# ── Audio Player ── %>
  <%= render "content_engine/audio/player", step: step, content: content %>

  <%# ── Collapsible Transcript ── %>
  <% if content&.audio_transcript.present? %>
    <details class="mt-6 rounded-[14px]" style="background: rgba(28,25,18,0.5); border: 1px solid rgba(232,228,220,0.06);">
      <summary class="px-5 py-3 text-sm font-medium cursor-pointer transition-colors"
               style="color: #7A7264; font-family: 'DM Sans', sans-serif;"
               onmouseover="this.style.color='#E8E4DC'" onmouseout="this.style.color='#7A7264'">
        <span class="ml-1"><%= t("audio_lesson.view_transcript") %></span>
      </summary>
      <div class="px-5 pb-4 text-sm leading-relaxed" style="color: #B0A898; font-family: 'DM Sans', sans-serif;">
        <%= simple_format(content.audio_transcript) %>
      </div>
    </details>
  <% end %>

  <%# ── Post-Audio Interaction ── %>
  <div class="mt-8 space-y-6">
    <div class="pt-6" style="border-top: 1px solid rgba(232,228,220,0.06);">
      <h2 class="text-lg font-semibold mb-4" style="color: #E8E4DC; font-family: 'DM Sans', sans-serif;">
        <%= t("audio_lesson.show_what_learned") %>
      </h2>

      <%# Discussion Question %>
      <% if narration["discussion_questions"].present? %>
        <div class="mb-6 rounded-[14px] p-4" style="background: rgba(99,102,241,0.08); border: 1px solid rgba(99,102,241,0.15);">
          <p class="text-xs font-medium uppercase tracking-wider mb-2"
             style="color: #818CF8; font-family: 'DM Mono', monospace;">
            <%= t("audio_lesson.reflection_question") %>
          </p>
          <p class="text-sm" style="color: #E8E4DC; font-family: 'DM Sans', sans-serif;">
            <%= narration["discussion_questions"].first %>
          </p>
        </div>
      <% end %>

      <%# Voice Response Recorder %>
      <div id="voice-interaction-<%= step.id %>">
        <%= render "assessments/voice_responses/recorder", step: step %>
      </div>

      <%# Step Quiz link %>
      <% if step.step_quiz.present? %>
        <div class="mt-6 pt-6" style="border-top: 1px solid rgba(232,228,220,0.06);">
          <p class="text-xs font-medium uppercase tracking-wider mb-3"
             style="color: #7A7264; font-family: 'DM Mono', monospace;">
            <%= t("audio_lesson.comprehension_quiz") %>
          </p>
          <%= link_to t("audio_lesson.start_quiz"),
              assessments.assessment_path(step.step_quiz),
              class: "inline-flex items-center gap-2 px-5 py-2.5 text-sm font-semibold text-white rounded-[11px] transition-all",
              style: "background: linear-gradient(135deg, #6366F1, #A855F7);" %>
        </div>
      <% end %>
    </div>
  </div>
</div>
