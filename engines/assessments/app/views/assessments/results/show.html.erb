<% content_for(:title, t("assessments.results.title_prefix") + @step.localized_title) %>

<div class="mx-auto max-w-3xl px-4 sm:px-6 lg:px-8 py-10">
  <!-- Score card -->
  <div class="text-center mb-10">
    <div class="inline-flex items-center justify-center w-24 h-24 rounded-full mb-4
                <%= @result.passed? ? 'bg-green-900/30 border-2 border-green-500/50' : 'bg-red-900/30 border-2 border-red-500/50' %>">
      <span class="text-3xl font-bold <%= @result.passed? ? 'text-green-400' : 'text-red-400' %>">
        <%= @result.score.round(0) %>%
      </span>
    </div>
    <h1 class="text-xl font-bold text-white mb-1">
      <%= @result.passed? ? t("assessments.results.congrats") : t("assessments.results.keep_going") %>
    </h1>
    <p class="text-sm text-gray-400">
      <%= @result.passed? ? t("assessments.results.passed_desc") : t("assessments.results.need_score", score: @assessment.passing_score) %>
    </p>
  </div>

  <!-- Stats -->
  <div class="grid grid-cols-3 gap-4 mb-8">
    <div class="bg-gray-900 border border-white/[0.06] rounded-xl p-4 text-center">
      <div class="text-lg font-bold text-white"><%= @answers.where(correct: true).count %></div>
      <div class="text-xs text-gray-500"><%= t("assessments.results.correct") %></div>
    </div>
    <div class="bg-gray-900 border border-white/[0.06] rounded-xl p-4 text-center">
      <div class="text-lg font-bold text-white"><%= @answers.where(correct: false).count %></div>
      <div class="text-xs text-gray-500"><%= t("assessments.results.incorrect") %></div>
    </div>
    <div class="bg-gray-900 border border-white/[0.06] rounded-xl p-4 text-center">
      <div class="text-lg font-bold text-white"><%= @assessment.questions.count - @answers.count %></div>
      <div class="text-xs text-gray-500"><%= t("assessments.results.unanswered") %></div>
    </div>
  </div>

  <!-- Per-question breakdown -->
  <h2 class="text-lg font-semibold text-white mb-4"><%= t("assessments.results.breakdown") %></h2>
  <div class="space-y-3">
    <% @assessment.questions.order(:created_at).each_with_index do |question, index| %>
      <% answer = @answers.find { |a| a.question_id == question.id } %>
      <div class="bg-gray-900 border border-white/[0.06] rounded-xl p-4">
        <div class="flex items-start gap-3">
          <div class="flex-shrink-0 w-7 h-7 rounded-full flex items-center justify-center text-xs font-bold
                      <%= answer&.correct? ? 'bg-green-900/50 text-green-400' : 'bg-red-900/50 text-red-400' %>">
            <% if answer&.correct? %>
              <svg aria-hidden="true" class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
            <% else %>
              <svg aria-hidden="true" class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>
            <% end %>
          </div>
          <div class="flex-1">
            <p class="text-sm text-gray-200 mb-1"><%= question.body %></p>
            <% if answer %>
              <p class="text-xs text-gray-500 mb-1"><%= t("assessments.results.your_answer") %> <span class="text-gray-300"><%= answer.answer.to_s.truncate(200) %></span></p>
            <% end %>
            <% if question.explanation.present? %>
              <p class="text-xs text-gray-400 mt-2"><%= question.explanation %></p>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>
  </div>

  <!-- Actions -->
  <div class="flex items-center justify-center gap-4 mt-8">
    <%= link_to t("assessments.results.back_to_route"), learning_routes_engine.route_path(@route),
        class: "rounded-lg px-4 py-2.5 text-sm font-medium text-gray-300 bg-gray-800 hover:bg-gray-700 border border-white/[0.06] transition" %>
    <% next_step = @route.route_steps.where("position > ?", @step.position).where(status: [:available]).order(:position).first %>
    <% if next_step %>
      <%= link_to t("assessments.results.continue"), learning_routes_engine.route_step_path(@route, next_step),
          class: "rounded-lg px-4 py-2.5 text-sm font-semibold text-white bg-gradient-to-r from-indigo-500 to-purple-500 hover:from-indigo-400 hover:to-purple-400 transition" %>
    <% end %>
  </div>
</div>
