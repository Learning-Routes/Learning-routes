<%= form_with model: route_request, url: create_route_wizard_path, data: { turbo: true, route_wizard_target: "form" } do |f| %>

  <%# === Step Progress Indicator ‚Äî 5 steps === %>
  <div style="max-width:560px; width:100%; margin-bottom:10px;" data-route-wizard-target="stepBar">
    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;">
      <div style="display:flex; gap:4px; align-items:center;">
        <span data-route-wizard-target="stepLabel" style="font-family:'DM Mono',monospace; font-weight:500; font-size:0.62rem; color:#1C1812;"><%= t("wizard.step_label", n: 1) %></span>
        <span style="font-family:'DM Mono',monospace; font-size:0.62rem; color:#D4CFC5;"><%= t("wizard.step_of") %></span>
        <span data-route-wizard-target="stepName" style="font-family:'DM Sans',sans-serif; font-weight:400; font-size:0.65rem; color:#9E9587; margin-left:8px;"><%= t("wizard.step0.step_name") %></span>
      </div>
      <span data-route-wizard-target="percentLabel" style="font-family:'DM Mono',monospace; font-size:0.6rem; color:#9E9587;">20%</span>
    </div>
    <div style="display:flex; gap:6px;">
      <% 5.times do |i| %>
        <div style="flex:1; height:3px; border-radius:2px; background:rgba(28,24,18,0.05); overflow:hidden;">
          <div data-route-wizard-target="bar<%= i %>" style="height:100%; width:<%= i == 0 ? '50%' : '0%' %>; opacity:<%= i == 0 ? '0.7' : '0' %>; background:#5BA880; border-radius:2px; transition:width 0.6s cubic-bezier(0.16,1,0.3,1), opacity 0.4s;"></div>
        </div>
      <% end %>
    </div>
  </div>

  <%# === Card Container === %>
  <div style="max-width:560px; width:100%; background:#FDFCFA; border-radius:20px; border:1px solid rgba(28,24,18,0.06); padding:36px 36px 28px; box-shadow:0 4px 24px rgba(28,24,18,0.04); opacity:0; transform:translateY(12px); animation:wizardCardEnter 0.5s cubic-bezier(0.16,1,0.3,1) 0.15s both;">

    <%# ============================================================ %>
    <%# STEP 0 ‚Äî TOPIC %>
    <%# ============================================================ %>
    <div data-route-wizard-target="step" data-step="0">
      <h2 style="font-family:'DM Sans',sans-serif; font-weight:700; font-size:1.8rem; letter-spacing:-0.3px; color:#1C1812; margin:0 0 6px;"><%= t("wizard.step0.heading") %></h2>
      <p style="font-family:'DM Sans',sans-serif; font-weight:400; font-size:0.82rem; color:#9E9587; margin:0 0 32px;"><%= t("wizard.step0.subtext") %></p>

      <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:10px; margin-bottom:28px;" data-route-wizard-target="topicGrid">
        <% [
          { id: "programming", emoji: "üíª", color: "#8B80C4" },
          { id: "languages", emoji: "üåç", color: "#6E9BC8" },
          { id: "math", emoji: "üìê", color: "#B09848" },
          { id: "science", emoji: "üî¨", color: "#5BA880" },
          { id: "business", emoji: "üìä", color: "#B5718E" },
          { id: "arts", emoji: "üé®", color: "#5A9E9E" }
        ].each do |topic| %>
          <div data-action="click->route-wizard#toggleTopic"
               data-topic="<%= topic[:id] %>"
               data-color="<%= topic[:color] %>"
               style="padding:20px 16px; border-radius:14px; cursor:pointer; position:relative; overflow:hidden; background:#FDFCFA; border:1.5px solid rgba(28,24,18,0.06); transition:all 0.3s cubic-bezier(0.16,1,0.3,1);">
            <div class="wizard-check" style="position:absolute; top:10px; right:10px; width:20px; height:20px; border-radius:6px; background:<%= topic[:color] %>; display:none; align-items:center; justify-content:center;">
              <svg width="12" height="12" viewBox="0 0 16 16" fill="none"><path d="M3 8.5L6.5 12L13 4" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </div>
            <div style="font-size:1.6rem; margin-bottom:10px;"><%= topic[:emoji] %></div>
            <div style="font-family:'DM Sans',sans-serif; font-weight:600; font-size:0.85rem; color:#1C1812; margin-bottom:3px;"><%= t("wizard.step0.topics.#{topic[:id]}") %></div>
            <div style="font-family:'DM Sans',sans-serif; font-weight:400; font-size:0.68rem; color:#9E9587;"><%= t("wizard.step0.topics.#{topic[:id]}_desc") %></div>
          </div>
        <% end %>
      </div>

      <div>
        <div style="font-family:'DM Sans',sans-serif; font-weight:600; font-size:0.72rem; color:#1C1812; margin-bottom:8px;"><%= t("wizard.step0.custom_label") %></div>
        <div style="display:flex; align-items:center; gap:10px; padding:12px 16px; border-radius:12px; background:#FDFCFA; border:1.5px solid rgba(28,24,18,0.06); transition:border-color 0.3s;" data-route-wizard-target="customInputWrap">
          <span style="font-size:0.9rem; opacity:0.4;">‚úèÔ∏è</span>
          <input type="text" name="route_request[custom_topic]" placeholder="<%= t("wizard.step0.custom_placeholder") %>" data-action="input->route-wizard#updateCustomTopic" data-route-wizard-target="customInput" style="flex:1; border:none; outline:none; background:none; font-family:'DM Sans',sans-serif; font-size:0.82rem; color:#1C1812;" autocomplete="off">
        </div>
      </div>

      <div data-route-wizard-target="topicInputs"></div>
    </div>

    <%# ============================================================ %>
    <%# STEP 1 ‚Äî LEVEL %>
    <%# ============================================================ %>
    <div data-route-wizard-target="step" data-step="1" style="display:none;">
      <h2 style="font-family:'DM Sans',sans-serif; font-weight:700; font-size:1.8rem; letter-spacing:-0.3px; color:#1C1812; margin:0 0 6px;"><%= t("wizard.step1.heading") %></h2>
      <p style="font-family:'DM Sans',sans-serif; font-weight:400; font-size:0.82rem; color:#9E9587; margin:0 0 32px;"><%= t("wizard.step1.subtext") %></p>

      <div style="display:flex; flex-direction:column; gap:10px;">
        <% [
          { id: "beginner", emoji: "üå±", color: "#5BA880" },
          { id: "basic", emoji: "üåø", color: "#6E9BC8" },
          { id: "intermediate", emoji: "üå≥", color: "#8B80C4" },
          { id: "advanced", emoji: "üèîÔ∏è", color: "#B09848" }
        ].each do |level| %>
          <div data-action="click->route-wizard#selectLevel" data-level="<%= level[:id] %>" data-color="<%= level[:color] %>" style="display:flex; align-items:center; gap:16px; padding:18px 20px; border-radius:14px; cursor:pointer; background:#FDFCFA; border:1.5px solid rgba(28,24,18,0.06); transition:all 0.3s cubic-bezier(0.16,1,0.3,1);">
            <div style="width:44px; height:44px; border-radius:12px; background:rgba(28,24,18,0.02); display:flex; align-items:center; justify-content:center; font-size:1.3rem; transition:background 0.3s;"><%= level[:emoji] %></div>
            <div style="flex:1;">
              <div style="font-family:'DM Sans',sans-serif; font-weight:600; font-size:0.88rem; color:#1C1812;"><%= t("wizard.step1.levels.#{level[:id]}") %></div>
              <div style="font-family:'DM Sans',sans-serif; font-weight:400; font-size:0.72rem; color:#9E9587; margin-top:2px;"><%= t("wizard.step1.levels.#{level[:id]}_desc") %></div>
            </div>
            <div style="width:22px; height:22px; border-radius:50%; border:2px solid rgba(28,24,18,0.1); display:flex; align-items:center; justify-content:center; transition:border-color 0.3s;">
              <div class="wizard-radio-dot" style="width:12px; height:12px; border-radius:50%; background:transparent; transform:scale(0); transition:all 0.3s cubic-bezier(0.16,1,0.3,1);"></div>
            </div>
          </div>
        <% end %>
      </div>
      <input type="hidden" name="route_request[level]" value="" data-route-wizard-target="levelInput">
    </div>

    <%# ============================================================ %>
    <%# STEP 2 ‚Äî GOAL %>
    <%# ============================================================ %>
    <div data-route-wizard-target="step" data-step="2" style="display:none;">
      <h2 style="font-family:'DM Sans',sans-serif; font-weight:700; font-size:1.8rem; letter-spacing:-0.3px; color:#1C1812; margin:0 0 6px;"><%= t("wizard.step2.heading") %></h2>
      <p style="font-family:'DM Sans',sans-serif; font-weight:400; font-size:0.82rem; color:#9E9587; margin:0 0 32px;"><%= t("wizard.step2.subtext") %></p>

      <div style="display:grid; grid-template-columns:repeat(2, 1fr); gap:10px;">
        <% [
          { id: "career", emoji: "üöÄ" },
          { id: "personal", emoji: "‚ú®" },
          { id: "exam", emoji: "üìù" },
          { id: "project", emoji: "üõ†Ô∏è" },
          { id: "switch", emoji: "üîÑ" },
          { id: "teaching", emoji: "üë•" }
        ].each do |goal| %>
          <div data-action="click->route-wizard#toggleGoal" data-goal="<%= goal[:id] %>" style="display:flex; align-items:center; gap:12px; padding:16px 18px; border-radius:12px; cursor:pointer; background:#FDFCFA; border:1.5px solid rgba(28,24,18,0.06); transition:all 0.3s cubic-bezier(0.16,1,0.3,1);">
            <span style="font-size:1.2rem;"><%= goal[:emoji] %></span>
            <span style="font-family:'DM Sans',sans-serif; font-weight:500; font-size:0.82rem; color:#1C1812; flex:1;"><%= t("wizard.step2.goals.#{goal[:id]}") %></span>
            <div class="wizard-goal-check" style="display:none; margin-left:auto;">
              <svg width="14" height="14" viewBox="0 0 16 16" fill="none"><path d="M3 8.5L6.5 12L13 4" stroke="#8B80C4" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </div>
          </div>
        <% end %>
      </div>
      <div data-route-wizard-target="goalInputs"></div>
    </div>

    <%# ============================================================ %>
    <%# STEP 3 ‚Äî LEARNING STYLE (VARK MINI-TEST) %>
    <%# ============================================================ %>
    <div data-route-wizard-target="step" data-step="3" style="display:none;">

      <%# Header %>
      <div style="margin-bottom:28px;">
        <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
          <span style="font-family:'DM Mono',monospace; font-size:0.55rem; font-weight:600; color:#8B80C4; text-transform:uppercase; letter-spacing:0.12em; background:rgba(139,128,196,0.08); padding:3px 10px; border-radius:6px;"><%= t("wizard.step3.mini_test") %></span>
          <span data-route-wizard-target="styleDoneMsg" style="font-family:'DM Sans',sans-serif; font-size:0.72rem; font-weight:500; color:#5BA880; opacity:0; transform:translateY(4px); transition:opacity 0.4s ease 0.2s, transform 0.4s ease 0.2s;"><%= t("wizard.step3.all_answered") %></span>
        </div>
        <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:12px;">
          <div>
            <h2 style="font-family:'DM Sans',sans-serif; font-weight:700; font-size:1.5rem; letter-spacing:-0.7px; color:#1C1812; margin:0 0 6px;"><%= t("wizard.step3.heading") %></h2>
            <p style="font-family:'DM Sans',sans-serif; font-weight:400; font-size:0.82rem; color:#A09889; margin:0;"><%= t("wizard.step3.subtext") %></p>
          </div>
          <span data-route-wizard-target="styleProgress" style="font-family:'DM Mono',monospace; font-size:0.68rem; color:#5BA880; white-space:nowrap; padding-top:4px;"><%= t("wizard.step3.progress", done: 0) %></span>
        </div>
      </div>

      <%# Questions Container %>
      <div style="display:flex; flex-direction:column; gap:24px;">
        <%
          style_icons = {
            1 => { v: "üé¨", a: "üó£Ô∏è", r: "üìñ", k: "üñ±Ô∏è" },
            2 => { v: "üó∫Ô∏è", a: "üéß", r: "üìù", k: "üö∂" },
            3 => { v: "üé®", a: "üîä", r: "‚úçÔ∏è", k: "üß™" },
            4 => { v: "üìä", a: "üí¨", r: "üìÑ", k: "üîß" },
            5 => { v: "üìπ", a: "üë®‚Äçüç≥", r: "üìã", k: "üç≥" },
            6 => { v: "üìê", a: "üìû", r: "üìë", k: "üî®" }
          }
          style_map = { "v" => "visual", "a" => "auditory", "r" => "reading", "k" => "kinesthetic" }
        %>

        <% (1..6).each_with_index do |qnum, qi| %>
          <%# Separator between questions %>
          <% if qi > 0 %>
            <div style="height:1px; background:rgba(28,24,18,0.04); margin:4px 0;"></div>
          <% end %>

          <div data-style-question="<%= qnum %>">
            <div style="font-family:'DM Mono',monospace; font-size:0.6rem; font-weight:500; color:#CCC5B8; margin-bottom:6px;"><%= qnum.to_s.rjust(2, '0') %></div>
            <div style="font-family:'DM Sans',sans-serif; font-weight:500; font-size:0.88rem; color:#1C1812; line-height:1.5; margin-bottom:12px;"><%= t("wizard.step3.questions.q#{qnum}.scenario") %></div>

            <div style="display:grid; grid-template-columns:repeat(2, 1fr); gap:8px;">
              <% %w[v a r k].each do |opt_key| %>
                <div data-action="click->route-wizard#selectStyleAnswer"
                     data-question="<%= qnum %>"
                     data-option="<%= qnum %><%= opt_key %>"
                     data-style="<%= style_map[opt_key] %>"
                     tabindex="0"
                     role="radio"
                     aria-label="<%= t("wizard.step3.questions.q#{qnum}.options.#{opt_key}") %>"
                     style="display:flex; align-items:center; gap:10px; padding:12px 14px; border-radius:12px; cursor:pointer; background:#FEFDFB; border:1.5px solid rgba(28,24,18,0.06); transition:all 0.25s cubic-bezier(0.16,1,0.3,1);"
                     onmouseenter="if(!this.querySelector('.style-check')?.style.display?.includes('flex')){this.style.borderColor='rgba(28,24,18,0.12)';this.style.transform='translateY(-1px)'}"
                     onmouseleave="if(!this.querySelector('.style-check')?.style.display?.includes('flex')){this.style.borderColor='rgba(28,24,18,0.06)';this.style.transform='translateY(0)'}"
                     onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.click()}">
                  <span style="font-size:1.1rem; flex-shrink:0;"><%= style_icons[qnum][opt_key.to_sym] %></span>
                  <span class="style-option-text" style="font-family:'DM Sans',sans-serif; font-weight:400; font-size:0.76rem; color:#1C1812; flex:1;"><%= t("wizard.step3.questions.q#{qnum}.options.#{opt_key}") %></span>
                  <div class="style-check" style="display:none; align-items:center; justify-content:center; width:16px; height:16px; flex-shrink:0;">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                      <circle cx="8" cy="8" r="8" fill="#8B80C4"/>
                      <path d="M4.5 8.5L7 11L11.5 5.5" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>

      <%# Hidden fields for style answers %>
      <% (1..6).each do |i| %>
        <input type="hidden" name="route_request[learning_style_answers][<%= i %>]" value="" data-route-wizard-target="styleAnswer<%= i %>">
      <% end %>

      <%# Result Preview Card (hidden until all 6 answered) %>
      <div data-route-wizard-target="styleResultCard" style="display:none; opacity:0; transform:translateY(8px); transition:opacity 0.4s ease 0.2s, transform 0.4s ease 0.2s; margin-top:20px; border-radius:12px; background:rgba(139,128,196,0.04); border:1px solid rgba(139,128,196,0.08); padding:14px 18px;">
        <div style="font-family:'DM Sans',sans-serif; font-weight:400; font-size:0.68rem; color:#A09889; margin-bottom:6px;"><%= t("wizard.step3.result_label") %></div>
        <div style="display:flex; align-items:center; gap:8px; margin-bottom:4px;">
          <span data-route-wizard-target="styleResultIcon" style="font-size:1.1rem;"></span>
          <span data-route-wizard-target="styleResultName" style="font-family:'DM Sans',sans-serif; font-weight:600; font-size:0.88rem; color:#1C1812;"></span>
        </div>
        <div data-route-wizard-target="styleResultDesc" style="font-family:'DM Sans',sans-serif; font-weight:400; font-size:0.7rem; color:#A09889; line-height:1.4;"></div>
        <div style="font-family:'DM Mono',monospace; font-size:0.58rem; color:#CCC5B8; margin-top:6px;"><%= t("wizard.step3.result_note") %></div>
      </div>
    </div>

    <%# ============================================================ %>
    <%# STEP 4 ‚Äî PACE %>
    <%# ============================================================ %>
    <div data-route-wizard-target="step" data-step="4" style="display:none;">
      <h2 style="font-family:'DM Sans',sans-serif; font-weight:700; font-size:1.8rem; letter-spacing:-0.3px; color:#1C1812; margin:0 0 6px;"><%= t("wizard.step4.heading") %></h2>
      <p style="font-family:'DM Sans',sans-serif; font-weight:400; font-size:0.82rem; color:#9E9587; margin:0 0 32px;"><%= t("wizard.step4.subtext") %></p>

      <div style="display:flex; flex-direction:column; gap:10px;">
        <% [
          { id: "relaxed", emoji: "üê¢", color: "#5BA880" },
          { id: "steady", emoji: "üö∂", color: "#6E9BC8" },
          { id: "intensive", emoji: "üèÉ", color: "#B09848" }
        ].each do |pace| %>
          <div data-action="click->route-wizard#selectPace" data-pace="<%= pace[:id] %>" data-color="<%= pace[:color] %>" style="display:flex; align-items:center; gap:16px; padding:20px; border-radius:14px; cursor:pointer; background:#FDFCFA; border:1.5px solid rgba(28,24,18,0.06); transition:all 0.3s cubic-bezier(0.16,1,0.3,1);">
            <div style="width:48px; height:48px; border-radius:14px; background:rgba(28,24,18,0.02); display:flex; align-items:center; justify-content:center; font-size:1.4rem; transition:background 0.3s;"><%= pace[:emoji] %></div>
            <div style="flex:1;">
              <div style="font-family:'DM Sans',sans-serif; font-weight:600; font-size:0.88rem; color:#1C1812;"><%= t("wizard.step4.paces.#{pace[:id]}") %></div>
              <div style="font-family:'DM Sans',sans-serif; font-weight:400; font-size:0.72rem; color:#9E9587; margin-top:2px;"><%= t("wizard.step4.paces.#{pace[:id]}_desc") %></div>
            </div>
            <div class="wizard-time-badge" style="font-family:'DM Mono',monospace; font-size:0.65rem; font-weight:500; padding:4px 10px; border-radius:8px; color:#9E9587; opacity:0.5; background:rgba(28,24,18,0.02); transition:all 0.3s;"><%= t("wizard.step4.paces.#{pace[:id]}_time") %></div>
          </div>
        <% end %>
      </div>
      <input type="hidden" name="route_request[pace]" value="" data-route-wizard-target="paceInput">
    </div>

    <%# ============================================================ %>
    <%# Card Footer %>
    <%# ============================================================ %>
    <div data-route-wizard-target="footer" style="display:flex; justify-content:flex-end; align-items:center; margin-top:32px; padding-top:20px; border-top:1px solid rgba(28,24,18,0.04); gap:12px;">
      <div style="flex:1; display:flex; gap:6px; flex-wrap:wrap;" data-route-wizard-target="chips"></div>
      <button type="button"
              data-action="click->route-wizard#next"
              data-route-wizard-target="continueBtn"
              disabled
              style="padding:12px 28px; border-radius:12px; border:none; font-family:'DM Sans',sans-serif; font-weight:600; font-size:0.82rem; cursor:default; background:rgba(28,24,18,0.06); color:#D4CFC5; display:flex; align-items:center; gap:8px; transition:all 0.3s cubic-bezier(0.16,1,0.3,1);">
        <span data-route-wizard-target="btnText"><%= t("wizard.continue") %></span>
        <span style="font-size:0.9rem; opacity:0.7;">‚Üí</span>
      </button>
    </div>
  </div>

<% end %>

<%# === Bottom hint === %>
<div data-route-wizard-target="bottomHint" style="text-align:center; margin-top:20px;">
  <span style="font-family:'DM Sans',sans-serif; font-size:0.68rem; color:#D4CFC5;"><%= t("wizard.bottom_hint") %></span>
</div>
