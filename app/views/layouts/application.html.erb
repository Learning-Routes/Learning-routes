<!DOCTYPE html>
<html lang="<%= I18n.locale %>" data-controller="theme" data-theme-preference-value="<%= current_theme %>">
  <head>
    <title><%= content_for(:title) || t("layout.app_name") %></title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Learning Routes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#F5F1EB">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= yield :head %>

    <link rel="icon" href="/icon.svg?v=2" type="image/svg+xml">
    <link rel="icon" href="/icon.png?v=2" type="image/png">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png?v=2">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300..700;1,9..40,300..700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">

    <%# Prevent flash of wrong theme before JS loads %>
    <script>
      (function(){
        var p = "<%= current_theme %>";
        var t = p === "system" ? (window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light") : p;
        document.documentElement.setAttribute("data-theme", t);
      })();
    </script>

    <%= stylesheet_link_tag "tailwind", "application", "data-turbo-track": "reload" %>
    <%= javascript_importmap_tags %>
  </head>

  <body style="margin:0; min-height:100vh; font-family:'DM Sans',sans-serif; background:var(--color-bg); color:var(--color-txt); transition:background-color 0.3s, color 0.3s;">
    <a href="#main-content" class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 focus:z-[200] focus:bg-accent focus:text-accent-text focus:px-4 focus:py-2 focus:rounded-btn focus:text-sm focus:font-semibold"><%= t("layout.skip_to_content") %></a>

    <%# === Subtle background texture (fixed, decorative) === %>
    <div style="position:fixed; inset:0; pointer-events:none; z-index:0;
                background:
                  radial-gradient(ellipse at 15% 25%, rgba(139,128,196,0.035) 0%, transparent 55%),
                  radial-gradient(ellipse at 85% 65%, rgba(91,168,128,0.03) 0%, transparent 50%);"
         class="theme-bg-texture"></div>

    <%# === Authenticated navbar (hidden when content_for(:hide_navbar) is set) === %>
    <% unless content_for?(:hide_navbar) %>
      <% if current_user %>
        <%= render "shared/app_navbar" %>
      <% else %>
        <%= render "shared/navbar" %>
      <% end %>
    <% end %>

    <%# === Flash messages === %>
    <% if flash[:notice] || flash[:alert] %>
      <div style="max-width:840px; margin:0 auto; padding:1rem 1.5rem 0;">
        <% if flash[:notice] %>
          <div data-controller="flash"
               style="background:rgba(91,168,128,0.1); border:1px solid rgba(91,168,128,0.18); border-radius:12px; padding:0.75rem 1rem; margin-bottom:0.5rem; display:flex; align-items:center; justify-content:space-between;">
            <p style="font-family:'DM Sans',sans-serif; font-size:0.8rem; font-weight:500; color:#3D7A5A; margin:0;"><%= flash[:notice] %></p>
            <button data-action="click->flash#dismiss" style="background:none; border:none; cursor:pointer; color:#3D7A5A; padding:0.2rem; opacity:0.6;" aria-label="<%= t(%(layout.dismiss)) %>">
              <svg width="14" height="14" viewBox="0 0 14 14" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" aria-hidden="true"><path d="M3 3l8 8M11 3l-8 8"/></svg>
            </button>
          </div>
        <% end %>
        <% if flash[:alert] %>
          <div data-controller="flash"
               style="background:rgba(176,96,80,0.08); border:1px solid rgba(176,96,80,0.15); border-radius:12px; padding:0.75rem 1rem; margin-bottom:0.5rem; display:flex; align-items:center; justify-content:space-between;">
            <p style="font-family:'DM Sans',sans-serif; font-size:0.8rem; font-weight:500; color:#B06050; margin:0;"><%= flash[:alert] %></p>
            <button data-action="click->flash#dismiss" style="background:none; border:none; cursor:pointer; color:#B06050; padding:0.2rem; opacity:0.6;" aria-label="<%= t(%(layout.dismiss)) %>">
              <svg width="14" height="14" viewBox="0 0 14 14" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" aria-hidden="true"><path d="M3 3l8 8M11 3l-8 8"/></svg>
            </button>
          </div>
        <% end %>
      </div>
    <% end %>

    <%# === Main content === %>
    <% if content_for?(:full_width) %>
      <main id="main-content" style="position:relative; z-index:1; margin:0 auto; padding:44px 0 80px;">
        <%= yield %>
      </main>
    <% else %>
      <main id="main-content" style="position:relative; z-index:1; max-width:840px; margin:0 auto; padding:44px 24px 80px;">
        <%= yield %>
      </main>
    <% end %>

  </body>
</html>
